<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Journal - 50 Day Challenge</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { min-height: 100vh; background: #08080c; font-family: system-ui, -apple-system, sans-serif; color: #fff; padding: 8px; overflow: hidden; }
        button { font-family: inherit; cursor: pointer; border: none; background: none; color: inherit; }
        
        .container { display: flex; flex-direction: column; height: calc(100vh - 16px); gap: 6px; position: relative; z-index: 10; }
        
        .header { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 18px; font-weight: 600; }
        .subtitle { font-size: 10px; color: #555; }
        .header-right { display: flex; gap: 4px; align-items: center; }
        
        .hamburger-btn { width: 32px; height: 32px; border-radius: 6px; background: rgba(12,12,18,0.95); border: 1px solid rgba(255,255,255,0.08); color: #888; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .hamburger-btn.active { color: #22c55e; border-color: rgba(34,197,94,0.3); }
        
        .hamburger-menu { position: absolute; top: 45px; left: 8px; background: linear-gradient(180deg,#1a1a1e,#121215); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); padding: 6px; min-width: 160px; z-index: 100; display: none; }
        .hamburger-menu.open { display: block; }
        .menu-item { width: 100%; padding: 10px 12px; border-radius: 6px; background: transparent; border: none; color: #ccc; font-size: 13px; text-align: left; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover { background: rgba(255,255,255,0.05); }
        .menu-item .icon { font-size: 14px; }
        
        .clock-btn { font-family: monospace; font-size: 12px; font-weight: 600; background: rgba(12,12,18,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 6px 8px; position: relative; user-select: none; }
        .clock-btn.active { color: #22c55e; border-color: rgba(34,197,94,0.3); }
        .clock-btn.inactive { color: #666; }
        .clock-strike { position: absolute; top: 50%; left: 4px; right: 4px; height: 1.5px; background: #ef4444; transform: rotate(-10deg); }
        
        .refresh-btn { width: 32px; height: 32px; border-radius: 6px; background: rgba(12,12,18,0.95); border: 1px solid rgba(255,255,255,0.08); color: #666; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 4px; margin-top: 4px; }
        .stat { padding: 6px 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; text-align: center; }
        .stat-label { font-size: 8px; color: #555; text-transform: uppercase; margin-bottom: 1px; }
        .stat-value { font-family: monospace; font-size: 12px; font-weight: 600; }
        .stat-value .dim { color: #444; }
        .green { color: #22c55e; }
        .red { color: #ef4444; }
        
        .calendar-wrap { flex: 1; border-radius: 10px; background: rgba(12,12,18,0.95); border: 1px solid rgba(255,255,255,0.06); padding: 6px; overflow: hidden; display: flex; flex-direction: column; }
        .calendar-slider { display: flex; width: 300%; transition: transform 0.3s ease; flex: 1; }
        .calendar-page { width: 33.333%; display: flex; flex-direction: column; gap: 4px; }
        .calendar-grid { display: flex; flex-direction: column; gap: 4px; flex: 1; }
        .calendar-row { display: flex; gap: 4px; flex: 1; }
        
        .calendar-toggles { display: flex; gap: 6px; margin-bottom: 4px; }
        .calendar-toggle { flex: 1; padding: 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 11px; font-weight: 500; }
        .calendar-toggle.active { border-color: rgba(34,197,94,0.5); background: rgba(34,197,94,0.1); color: #22c55e; }
        
        .graph-page { padding: 6px; justify-content: flex-start; }
        .graph-toggles { display: flex; gap: 6px; margin-bottom: 4px; }
        .graph-toggle { flex: 1; padding: 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 11px; font-weight: 500; }
        .graph-toggle.active { border-color: rgba(34,197,94,0.5); background: rgba(34,197,94,0.1); color: #22c55e; }
        .win-rate-row { display: flex; gap: 3px; margin-bottom: 4px; overflow-x: auto; padding-bottom: 2px; }
        .win-rate-item { flex: 0 0 auto; padding: 3px 6px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 4px; text-align: center; min-width: 42px; }
        .win-rate-time { font-size: 8px; color: #666; }
        .win-rate-pct { font-size: 10px; font-weight: 600; }
        .win-rate-pct.high { color: #22c55e; }
        .win-rate-pct.mid { color: #eab308; }
        .win-rate-pct.low { color: #ef4444; }
        #graphCanvas { width: 100%; flex: 1; background: rgba(0,0,0,0.2); border-radius: 8px; min-height: 120px; }
        
        .day-box { flex: 1; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); }
        .day-box.has-trades { background: linear-gradient(135deg,rgba(34,197,94,0.1),rgba(34,197,94,0.02)); border-color: rgba(34,197,94,0.2); }
        .day-box.negative { background: linear-gradient(135deg,rgba(239,68,68,0.15),rgba(239,68,68,0.05)); border-color: rgba(239,68,68,0.3); }
        .day-box.week { background: linear-gradient(135deg,rgba(34,197,94,0.2),rgba(34,197,94,0.05)); border-color: rgba(34,197,94,0.4); }
        .day-box.week.negative { background: linear-gradient(135deg,rgba(239,68,68,0.2),rgba(239,68,68,0.05)); border-color: rgba(239,68,68,0.4); }
        .day-box.today { box-shadow: 0 0 0 2px #22c55e; }
        .day-label { font-size: 8px; color: #555; margin-bottom: 1px; }
        .day-label.week { font-weight: 600; color: #888; letter-spacing: 0.5px; }
        .day-count { font-family: monospace; font-size: 14px; font-weight: 700; }
        .day-count .slash { font-size: 10px; color: #444; }
        .day-count .total { font-size: 10px; color: #555; }
        .day-r { font-family: monospace; font-size: 9px; font-weight: 600; }
        .week-r { font-family: monospace; font-size: 11px; font-weight: 700; }
        .week-money { font-family: monospace; font-size: 9px; font-weight: 600; }
        
        .dots { display: flex; justify-content: center; gap: 6px; padding: 4px 0; }
        .dot { width: 6px; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.2); transition: all 0.2s; }
        .dot.active { width: 18px; background: #22c55e; }
        
        .balance-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
        .balance-box { padding: 6px 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .balance-label { font-size: 8px; color: #555; text-transform: uppercase; }
        .balance-value { font-family: monospace; font-size: 11px; font-weight: 600; }
        
        .progress-section { margin-top: 4px; padding: 6px 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .progress-label { font-size: 8px; color: #555; text-transform: uppercase; }
        .progress-value { font-size: 10px; color: #888; font-weight: 500; }
        .progress-bar-wrap { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #22c55e, #4ade80); border-radius: 3px; transition: width 0.3s ease; width: 0%; }
        
        .goals-row { display: grid; grid-template-columns: 1fr 1fr 0.5fr; gap: 4px; margin-top: 4px; }
        .goal-box { padding: 6px 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; text-align: center; }
        .goal-label { font-size: 8px; color: #555; text-transform: uppercase; margin-bottom: 2px; }
        .goal-progress { font-family: monospace; font-size: 11px; font-weight: 600; }
        .goal-current { color: #22c55e; }
        .goal-current.behind { color: #ef4444; }
        .goal-dim { color: #444; }
        .goal-target { color: #888; }
        .goal-icon { font-size: 14px; }
        .goal-box.achieved { border-color: rgba(34,197,94,0.4); background: rgba(34,197,94,0.1); }
        
        .tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag-btn { padding: 6px 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: #888; font-size: 11px; transition: all 0.2s; }
        .tag-btn.active { border-color: rgba(34,197,94,0.5); background: rgba(34,197,94,0.15); color: #22c55e; }
        
        .r-btns { display: flex; gap: 8px; }
        .r-btn { flex: 1; padding: 12px 8px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); font-size: 14px; font-weight: 700; font-family: monospace; transition: all 0.2s; }
        .r-btn.positive { color: #22c55e; }
        .r-btn.negative { color: #ef4444; }
        .r-btn.positive.active { border-color: #22c55e; background: rgba(34,197,94,0.2); }
        .r-btn.negative.active { border-color: #ef4444; background: rgba(239,68,68,0.2); }
        
        .review-content { font-size: 13px; line-height: 1.6; }
        .review-section { margin-bottom: 16px; }
        .review-title { font-size: 14px; font-weight: 600; color: #22c55e; margin-bottom: 8px; }
        .review-stat { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .review-stat-label { color: #888; }
        .review-stat-value { font-family: monospace; font-weight: 600; }
        .review-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .review-tag { padding: 4px 8px; border-radius: 12px; background: rgba(255,255,255,0.05); font-size: 11px; color: #888; }
        .review-tag .count { color: #22c55e; margin-left: 4px; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal-overlay.hidden { display: none; }
        .modal { background: linear-gradient(180deg,#141418,#0c0c10); border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); width: 100%; max-width: 360px; max-height: 80vh; overflow-y: auto; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 28px; height: 28px; border-radius: 6px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); color: #888; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .modal-back { padding: 6px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); color: #888; font-size: 12px; }
        
        .menu-btn { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #fff; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; text-align: left; }
        .menu-btn.green { border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.08); color: #22c55e; }
        .menu-btn .icon { font-size: 18px; }
        
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 11px; color: #666; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: #1a1a1a; color: #fff; font-size: 14px; }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
        
        .type-btns { display: flex; gap: 6px; }
        .type-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 12px; text-align: center; }
        .type-btn.active { border-color: rgba(34,197,94,0.5); background: rgba(34,197,94,0.1); color: #22c55e; }
        
        .submit-btn { width: 100%; padding: 12px 20px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3); background: rgba(34,197,94,0.08); color: #22c55e; font-size: 14px; font-weight: 500; }
        .submit-btn.secondary { border-color: rgba(59,130,246,0.3); background: rgba(59,130,246,0.08); color: #3b82f6; }
        .view-btns { display: flex; gap: 8px; margin-top: 12px; }
        .view-btns .submit-btn { flex: 1; font-size: 11px; padding: 10px 6px; }
        
        .trade-item { padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); border-left: 3px solid #22c55e; background: rgba(255,255,255,0.02); display: flex; align-items: center; margin-bottom: 6px; }
        .trade-item.setup { border-left-color: #444; opacity: 0.7; }
        .trade-info { flex: 1; }
        .trade-ticker { font-family: monospace; font-size: 14px; font-weight: 600; }
        .trade-time { font-size: 10px; color: #555; }
        .trade-r { font-family: monospace; font-size: 16px; font-weight: 700; margin-right: 10px; }
        .trade-btn { width: 28px; height: 28px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 12px; margin-left: 6px; display: flex; align-items: center; justify-content: center; }
        
        .empty-state { text-align: center; padding: 24px; color: #555; }
        .empty-icon { font-size: 28px; margin-bottom: 8px; }
        
        .week-section { margin-bottom: 16px; }
        .week-section-title { font-size: 11px; color: #555; text-transform: uppercase; margin-bottom: 10px; }
        .week-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .week-stat { padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); text-align: center; }
        .week-stat.full { grid-column: span 2; padding: 12px; }
        .week-stat.positive { border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.05); }
        .week-stat.negative { border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.05); }
        .week-stat-value { font-family: monospace; font-size: 18px; font-weight: 700; }
        .week-stat-value.big { font-size: 20px; }
        .week-stat-label { font-size: 9px; color: #555; }
        
        .clear-btn { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.08); color: #ef4444; font-size: 13px; font-weight: 500; margin-bottom: 8px; }
        .cancel-btn { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 13px; font-weight: 500; }
        
        .balance-presets { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .balance-preset { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 11px; }
        
        .photo-btns { display: flex; gap: 6px; margin-bottom: 8px; }
        .photo-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #888; font-size: 12px; text-align: center; }
        .photo-preview { display: none; }
        .photo-preview.has-photo { display: block; margin-top: 8px; position: relative; }
        .photo-preview img { width: 100%; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .photo-remove { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .modal-text { color: #666; margin-bottom: 16px; font-size: 13px; }
        
        /* Canvas */
        #bgCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    
    <div class="container">
        <div class="header">
            <div style="display:flex;align-items:center;gap:8px;">
                <button class="hamburger-btn" id="hamburgerBtn">‚ò∞</button>
                <div>
                    <div class="title">Trading Journal</div>
                    <div class="subtitle">50-Day Challenge</div>
                </div>
            </div>
            <div class="header-right">
                <button class="clock-btn inactive" id="clockBtn">
                    <span id="clockDisplay">0:00:00 AM</span>
                    <div class="clock-strike" id="clockStrike"></div>
                </button>
                <button class="refresh-btn" id="refreshBtn">‚Üª</button>
            </div>
        </div>
        
        <div class="hamburger-menu" id="hamburgerMenu">
            <button class="menu-item" id="exportBtn"><span class="icon">üì§</span>Export Data</button>
            <button class="menu-item" id="importBtn"><span class="icon">üì•</span>Import Data</button>
        </div>
        <input type="file" accept=".json" id="importFile" style="display:none">
        
        <div class="calendar-wrap" id="calendarWrap">
            <div class="calendar-slider" id="calendarSlider">
                <div class="calendar-page" id="page0">
                    <div class="calendar-toggles">
                        <button class="calendar-toggle active" id="calMyTrades0">My Trades</button>
                        <button class="calendar-toggle" id="calAllTrades0">All Trades</button>
                    </div>
                    <div class="calendar-grid" id="grid0"></div>
                </div>
                <div class="calendar-page" id="page1">
                    <div class="calendar-toggles">
                        <button class="calendar-toggle active" id="calMyTrades1">My Trades</button>
                        <button class="calendar-toggle" id="calAllTrades1">All Trades</button>
                    </div>
                    <div class="calendar-grid" id="grid1"></div>
                </div>
                <div class="calendar-page graph-page" id="page2">
                    <div class="graph-toggles">
                        <button class="graph-toggle active" id="graphMyTrades">My Trades</button>
                        <button class="graph-toggle" id="graphAllTrades">All Trades</button>
                        <button class="graph-toggle" id="graphCompare">Compare</button>
                    </div>
                    <div class="win-rate-row" id="winRateRow"></div>
                    <canvas id="graphCanvas"></canvas>
                </div>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Trades</div>
                    <div class="stat-value"><span id="statTrades">0</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">W/L</div>
                    <div class="stat-value"><span class="green" id="statWins">0</span><span class="dim">/</span><span class="red" id="statLosses">0</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Total R</div>
                    <div class="stat-value" id="statR">0.0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="statStreak">-</div>
                </div>
                <button class="stat" id="balanceBtn">
                    <div class="stat-label">Balance</div>
                    <div class="stat-value green" id="statBalance">$1,000</div>
                </button>
            </div>
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Challenge Progress</span>
                    <span class="progress-value" id="progressDays">0/50 days</span>
                </div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            <div class="goals-row">
                <button class="goal-box" id="dailyGoalBtn">
                    <div class="goal-label">Daily Goal</div>
                    <div class="goal-progress">
                        <span class="goal-current" id="dailyGoalCurrent">0</span><span class="goal-dim">/</span><span class="goal-target" id="dailyGoalTarget">2R</span>
                    </div>
                </button>
                <button class="goal-box" id="weeklyGoalBtn">
                    <div class="goal-label">Weekly Goal</div>
                    <div class="goal-progress">
                        <span class="goal-current" id="weeklyGoalCurrent">0</span><span class="goal-dim">/</span><span class="goal-target" id="weeklyGoalTarget">10R</span>
                    </div>
                </button>
                <button class="goal-box" id="weeklyReviewBtn">
                    <div class="goal-label">Review</div>
                    <div class="goal-icon">üìä</div>
                </button>
            </div>
            <div class="balance-row">
                <div class="balance-box">
                    <span class="balance-label">Real</span>
                    <span class="balance-value" id="realBalance">$1,000 (+0%)</span>
                </div>
                <div class="balance-box">
                    <span class="balance-label">Setups</span>
                    <span class="balance-value" id="setupsBalance">$1,000 (+0%)</span>
                </div>
            </div>
        </div>
        
        <div class="dots">
            <button class="dot active" id="dot0"></button>
            <button class="dot" id="dot1"></button>
            <button class="dot" id="dot2"></button>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay hidden" id="menuModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="menuTitle">Day 1</div>
                <button class="modal-close" id="menuClose">√ó</button>
            </div>
            <button class="menu-btn green" id="addTradeBtn"><span class="icon">+</span>Add Trade</button>
            <button class="menu-btn" id="viewTradesBtn"><span class="icon">üìä</span>View Trades</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="viewModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-back" id="viewBack">‚Üê Back</button>
                <button class="modal-close" id="viewClose">√ó</button>
            </div>
            <div class="modal-title" style="margin-bottom:12px" id="viewTitle">Day 1 Trades</div>
            <div id="tradesList"></div>
            <div class="view-btns">
                <button class="submit-btn" id="viewAddBtn">+ Add Trade</button>
                <button class="submit-btn secondary" id="duplicateBtn">üìã Duplicate Last</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-back" id="addBack">‚Üê Back</button>
                <button class="modal-close" id="addClose">√ó</button>
            </div>
            <div class="modal-title" style="margin-bottom:16px">Add Trade</div>
            <div class="form-group">
                <label class="form-label">Ticker</label>
                <input type="text" class="form-input" id="tickerInput" placeholder="AAPL">
            </div>
            <div class="form-group">
                <label class="form-label">Time</label>
                <select class="form-select" id="timeSelect"></select>
            </div>
            <div class="form-group">
                <label class="form-label">R Result</label>
                <div class="r-btns" id="rBtns">
                    <button class="r-btn positive active" data-r="2">+2R</button>
                    <button class="r-btn positive" data-r="1">+1R</button>
                    <button class="r-btn negative" data-r="-1">-1R</button>
                    <button class="r-btn negative" data-r="-2">-2R</button>
                </div>
                <input type="hidden" id="rSelect" value="2">
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <div class="type-btns">
                    <button class="type-btn active" id="typeTaken">Trade Taken</button>
                    <button class="type-btn" id="typeSetup">Setup Only</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Tags</label>
                <div class="tags-wrap" id="tagsWrap">
                    <button class="tag-btn" data-tag="Perfect Setup">‚ú® Perfect Setup</button>
                    <button class="tag-btn" data-tag="FOMO">üò∞ FOMO</button>
                    <button class="tag-btn" data-tag="Revenge">üò§ Revenge</button>
                    <button class="tag-btn" data-tag="Oversize">üìà Oversize</button>
                    <button class="tag-btn" data-tag="Early Entry">‚è∞ Early</button>
                    <button class="tag-btn" data-tag="Late Entry">üê¢ Late</button>
                    <button class="tag-btn" data-tag="Patience">üßò Patience</button>
                    <button class="tag-btn" data-tag="News">üì∞ News</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-input" id="notesInput" placeholder="Trade notes..." rows="3" style="resize:none"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Chart Photo</label>
                <input type="file" accept="image/*" capture="environment" id="photoInput" style="display:none">
                <div class="photo-btns">
                    <button class="photo-btn" id="takePhotoBtn">üì∑ Take Photo</button>
                    <button class="photo-btn" id="choosePhotoBtn">üñºÔ∏è Choose Photo</button>
                </div>
                <div id="photoPreview" class="photo-preview"></div>
            </div>
            <button class="submit-btn" id="submitTrade">Add Trade</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-back" id="editBack">‚Üê Back</button>
                <button class="modal-close" id="editClose">√ó</button>
            </div>
            <div class="modal-title" style="margin-bottom:16px">Edit Trade</div>
            <div class="form-group">
                <label class="form-label">Ticker</label>
                <input type="text" class="form-input" id="editTickerInput">
            </div>
            <div class="form-group">
                <label class="form-label">Time</label>
                <select class="form-select" id="editTimeSelect"></select>
            </div>
            <div class="form-group">
                <label class="form-label">R Result</label>
                <div class="r-btns" id="editRBtns">
                    <button class="r-btn positive" data-r="2">+2R</button>
                    <button class="r-btn positive" data-r="1">+1R</button>
                    <button class="r-btn negative" data-r="-1">-1R</button>
                    <button class="r-btn negative" data-r="-2">-2R</button>
                </div>
                <input type="hidden" id="editRSelect" value="2">
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <div class="type-btns">
                    <button class="type-btn" id="editTypeTaken">Trade Taken</button>
                    <button class="type-btn" id="editTypeSetup">Setup Only</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Tags</label>
                <div class="tags-wrap" id="editTagsWrap">
                    <button class="tag-btn" data-tag="Perfect Setup">‚ú® Perfect Setup</button>
                    <button class="tag-btn" data-tag="FOMO">üò∞ FOMO</button>
                    <button class="tag-btn" data-tag="Revenge">üò§ Revenge</button>
                    <button class="tag-btn" data-tag="Oversize">üìà Oversize</button>
                    <button class="tag-btn" data-tag="Early Entry">‚è∞ Early</button>
                    <button class="tag-btn" data-tag="Late Entry">üê¢ Late</button>
                    <button class="tag-btn" data-tag="Patience">üßò Patience</button>
                    <button class="tag-btn" data-tag="News">üì∞ News</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-input" id="editNotesInput" placeholder="Trade notes..." rows="3" style="resize:none"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Chart Photo</label>
                <input type="file" accept="image/*" capture="environment" id="editPhotoInput" style="display:none">
                <div class="photo-btns">
                    <button class="photo-btn" id="editTakePhotoBtn">üì∑ Take Photo</button>
                    <button class="photo-btn" id="editChoosePhotoBtn">üñºÔ∏è Choose Photo</button>
                </div>
                <div id="editPhotoPreview" class="photo-preview"></div>
            </div>
            <button class="submit-btn" id="saveEdit">Save Changes</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="weekModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="weekTitle">Week 1</div>
                <button class="modal-close" id="weekClose">√ó</button>
            </div>
            <div class="week-section">
                <div class="week-section-title">Your Trades</div>
                <div class="week-grid">
                    <div class="week-stat full" id="weekMyR"></div>
                    <div class="week-stat"><div class="week-stat-value" id="weekMyTrades">0</div><div class="week-stat-label">TRADES</div></div>
                    <div class="week-stat"><div class="week-stat-value" id="weekMyWinRate">0%</div><div class="week-stat-label">WIN RATE</div></div>
                    <div class="week-stat"><div class="week-stat-value green" id="weekMyWins">0</div><div class="week-stat-label">WINS</div></div>
                    <div class="week-stat"><div class="week-stat-value red" id="weekMyLosses">0</div><div class="week-stat-label">LOSSES</div></div>
                </div>
            </div>
            <div class="week-section">
                <div class="week-section-title">All Setups</div>
                <div class="week-grid">
                    <div class="week-stat full" id="weekAllR"></div>
                    <div class="week-stat"><div class="week-stat-value" id="weekAllTrades">0</div><div class="week-stat-label">SETUPS</div></div>
                    <div class="week-stat"><div class="week-stat-value" id="weekAllWinRate">0%</div><div class="week-stat-label">WIN RATE</div></div>
                    <div class="week-stat"><div class="week-stat-value green" id="weekAllWins">0</div><div class="week-stat-label">WINS</div></div>
                    <div class="week-stat"><div class="week-stat-value red" id="weekAllLosses">0</div><div class="week-stat-label">LOSSES</div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="clearModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Clear Data</div>
                <button class="modal-close" id="clearClose">√ó</button>
            </div>
            <p class="modal-text">Which page to clear?</p>
            <button class="clear-btn" id="clearPage1">Page 1 (Days 1-25)</button>
            <button class="clear-btn" id="clearPage2">Page 2 (Days 26-50)</button>
            <button class="cancel-btn" id="clearCancel">Cancel</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="balanceModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Set Balance</div>
                <button class="modal-close" id="balanceClose">√ó</button>
            </div>
            <p class="modal-text">Current: <span id="currentBalance">$1,000</span></p>
            <div class="form-group">
                <input type="number" class="form-input" id="balanceInput" placeholder="Enter amount">
            </div>
            <div class="balance-presets">
                <button class="balance-preset" data-amount="100">$100</button>
                <button class="balance-preset" data-amount="500">$500</button>
                <button class="balance-preset" data-amount="1000">$1,000</button>
                <button class="balance-preset" data-amount="5000">$5,000</button>
                <button class="balance-preset" data-amount="10000">$10,000</button>
                <button class="balance-preset" data-amount="50000">$50,000</button>
            </div>
            <button class="submit-btn" id="saveBalance">Set Balance</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="reviewModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Weekly Review</div>
                <button class="modal-close" id="reviewClose">√ó</button>
            </div>
            <div class="review-content" id="reviewContent"></div>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="goalModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="goalModalTitle">Set Daily Goal</div>
                <button class="modal-close" id="goalClose">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Target R</label>
                <input type="number" class="form-input" id="goalInput" placeholder="Enter target R" step="0.5">
            </div>
            <div class="balance-presets">
                <button class="goal-preset" data-amount="1">1R</button>
                <button class="goal-preset" data-amount="2">2R</button>
                <button class="goal-preset" data-amount="3">3R</button>
                <button class="goal-preset" data-amount="4">4R</button>
                <button class="goal-preset" data-amount="5">5R</button>
                <button class="goal-preset" data-amount="10">10R</button>
            </div>
            <button class="submit-btn" id="saveGoal">Set Goal</button>
        </div>
    </div>

    <script>
        // IndexedDB for large storage (hundreds of MB)
        let db;
        const DB_NAME = 'TradingJournalDB';
        const DB_VERSION = 1;
        
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('data')) {
                        database.createObjectStore('data', { keyPath: 'id' });
                    }
                };
            });
        }
        
        function saveToDB(key, value) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('data', 'readwrite');
                const store = tx.objectStore('data');
                store.put({ id: key, value: value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }
        
        function loadFromDB(key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('data', 'readonly');
                const store = tx.objectStore('data');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result ? request.result.value : null);
                request.onerror = () => reject(request.error);
            });
        }
        
        // Data
        let days = Array.from({length: 50}, (_, i) => ({ id: i, trades: [] }));
        let startingBalance = 1000;
        let currentPage = 0;
        let selectedDay = null;
        let selectedWeek = null;
        let editingTrade = null;
        let newTradeTaken = true;
        let editTradeTaken = true;
        let newTradePhoto = null;
        let editTradePhoto = null;
        let newTradeTags = [];
        let editTradeTags = [];
        let currentGoalType = 'daily'; // 'daily' or 'weekly'
        let todayIndex = 0; // Which day is "today" in the challenge
        let graphShowAll = false; // false = my trades, true = all trades
        let graphCompareMode = false; // true = show both overlaid
        let calendarShowAll = false; // false = my trades, true = all trades
        let dailyGoal = 2; // Target R per day
        let weeklyGoal = 10; // Target R per week
        
        // Audio
        let audioCtx = null;
        let beepOn = false;
        let lastSecond = -1;
        
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playBeep(freq, dur) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; osc.type = 'sine';
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }
        
        // Clock
        function updateClock() {
            const now = new Date();
            let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
            const ap = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            document.getElementById('clockDisplay').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} ${ap}`;
            
            if (beepOn && s !== lastSecond) {
                lastSecond = s;
                if ([10,11,12,13,25,26,27,28,40,41,42,43,55,56,57,58].includes(s)) playBeep(440, 0.15);
                else if ([14,29,44,59].includes(s)) { playBeep(440, 0.15); setTimeout(() => playBeep(600, 0.2), 650); }
                else if ([0,15,30,45].includes(s)) playBeep(880, 0.3);
            }
        }
        setInterval(updateClock, 100);
        updateClock();
        
        document.getElementById('clockBtn').addEventListener('click', () => {
            initAudio();
            beepOn = !beepOn;
            const btn = document.getElementById('clockBtn');
            const strike = document.getElementById('clockStrike');
            if (beepOn) { btn.classList.remove('inactive'); btn.classList.add('active'); strike.style.display = 'none'; }
            else { btn.classList.remove('active'); btn.classList.add('inactive'); strike.style.display = 'block'; }
        });
        
        // Canvas animation
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        for (let i = 0; i < 60; i++) particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, s: Math.random() * 2.5 + 1, o: Math.random() * 0.4 + 0.1 });
        
        function drawParticles() {
            ctx.fillStyle = 'rgba(8,8,12,0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0) p.x = canvas.width; if (p.x > canvas.width) p.x = 0;
                if (p.y < 0) p.y = canvas.height; if (p.y > canvas.height) p.y = 0;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(34,197,94,${p.o})`; ctx.fill();
                particles.slice(i + 1).forEach(p2 => {
                    const d = Math.hypot(p.x - p2.x, p.y - p2.y);
                    if (d < 120) { ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.strokeStyle = `rgba(34,197,94,${0.15 * (1 - d / 120)})`; ctx.lineWidth = 0.5; ctx.stroke(); }
                });
            });
            requestAnimationFrame(drawParticles);
        }
        drawParticles();
        
        // Time options
        const times = [];
        for (let h = 4; h <= 8; h++) for (let m = 0; m < 60; m += 15) times.push(`${h}:${m.toString().padStart(2,'0')} AM`);
        for (let h = 9; h <= 11; h++) for (let m = 0; m < 60; m += 5) times.push(`${h}:${m.toString().padStart(2,'0')} AM`);
        times.push('12:00 PM');
        for (let m = 5; m < 60; m += 5) times.push(`12:${m.toString().padStart(2,'0')} PM`);
        for (let h = 1; h <= 4; h++) for (let m = 0; m < 60; m += 15) times.push(`${h}:${m.toString().padStart(2,'0')} PM`);
        
        ['timeSelect', 'editTimeSelect'].forEach(id => {
            const sel = document.getElementById(id);
            times.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; sel.appendChild(opt); });
            sel.value = '9:30 AM';
        });
        
        // Save data
        function saveData() { 
            saveToDB('days', days);
            saveToDB('balance', startingBalance);
        }
        
        // Calculate stats
        function calcStats() {
            let myCount = 0, myWins = 0, myLosses = 0, myR = 0;
            let allCount = 0, allWins = 0, allLosses = 0, allR = 0;
            days.forEach(d => {
                d.trades.forEach(t => {
                    allCount++; allR += t.r; 
                    if (t.r > 0) allWins++; else if (t.r < 0) allLosses++;
                    if (t.taken) { 
                        myCount++; myR += t.r; 
                        if (t.r > 0) myWins++; else if (t.r < 0) myLosses++; 
                    }
                });
            });
            return { myCount, myWins, myLosses, myR, allCount, allWins, allLosses, allR };
        }
        
        function calcWeek(wi) {
            const wd = days.slice(wi * 5, wi * 5 + 5);
            let my = 0, myW = 0, myL = 0, myR = 0, all = 0, allW = 0, allL = 0, allR = 0;
            wd.forEach(d => d.trades.forEach(t => {
                all++; allR += t.r; if (t.r > 0) allW++; else if (t.r < 0) allL++;
                if (t.taken) { my++; myR += t.r; if (t.r > 0) myW++; else if (t.r < 0) myL++; }
            }));
            return { my, myW, myL, myR, all, allW, allL, allR };
        }
        
        function dayR(d) { return d.trades.filter(t => t.taken).reduce((s, t) => s + t.r, 0); }
        
        let graphSlots = []; // Store slots for click detection
        
        function renderGraph(animate = true) {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            const width = rect.width;
            const height = rect.height;
            const padding = { top: 15, right: 10, bottom: 25, left: 30 };
            const graphWidth = width - padding.left - padding.right;
            const graphHeight = height - padding.top - padding.bottom;
            
            // Collect trades by time slot - separate positive and negative
            const timeSlots = {};
            days.forEach((d, dayIndex) => {
                d.trades.forEach(t => {
                    if (graphShowAll || t.taken) {
                        const timeKey = t.time;
                        if (!timeSlots[timeKey]) {
                            timeSlots[timeKey] = { positiveR: 0, negativeR: 0, positiveCount: 0, negativeCount: 0, time: t.time, trades: [] };
                        }
                        if (t.r >= 0) {
                            timeSlots[timeKey].positiveR += t.r;
                            timeSlots[timeKey].positiveCount++;
                        } else {
                            timeSlots[timeKey].negativeR += t.r;
                            timeSlots[timeKey].negativeCount++;
                        }
                        timeSlots[timeKey].trades.push({ ...t, dayIndex });
                    }
                });
            });
            
            // Render win rate row
            const winRateRow = document.getElementById('winRateRow');
            const slots = Object.values(timeSlots);
            slots.sort((a, b) => {
                const parseTime = (t) => {
                    const parts = t.match(/(\d+):(\d+)\s*(AM|PM)/i);
                    if (!parts) return 0;
                    let h = parseInt(parts[1]);
                    const m = parseInt(parts[2]);
                    const ampm = parts[3].toUpperCase();
                    if (ampm === 'PM' && h !== 12) h += 12;
                    if (ampm === 'AM' && h === 12) h = 0;
                    return h * 60 + m;
                };
                return parseTime(a.time) - parseTime(b.time);
            });
            
            if (slots.length > 0) {
                winRateRow.innerHTML = slots.map(slot => {
                    const total = slot.positiveCount + slot.negativeCount;
                    const winRate = total > 0 ? Math.round((slot.positiveCount / total) * 100) : 0;
                    const cls = winRate >= 60 ? 'high' : winRate >= 40 ? 'mid' : 'low';
                    const timeLabel = slot.time.replace(':00', '').replace(' ', '');
                    return '<div class="win-rate-item"><div class="win-rate-time">' + timeLabel + '</div><div class="win-rate-pct ' + cls + '">' + winRate + '%</div></div>';
                }).join('');
            } else {
                winRateRow.innerHTML = '';
            }
            
            // Find max R for scaling
            const maxPositive = Math.max(...slots.map(s => s.positiveR), 1);
            const maxNegative = Math.max(...slots.map(s => Math.abs(s.negativeR)), 1);
            const maxR = Math.max(4, maxPositive, maxNegative);
            
            const zeroY = padding.top + graphHeight / 2;
            const barWidth = slots.length > 0 ? Math.min(30, (graphWidth / slots.length) - 4) : 30;
            const gap = slots.length > 0 ? (graphWidth - barWidth * slots.length) / (slots.length + 1) : 0;
            
            // Store bar positions for click detection
            graphSlots = slots.map((slot, i) => ({
                ...slot,
                x: padding.left + gap + i * (barWidth + gap),
                barWidth: barWidth,
                zeroY: zeroY,
                maxR: maxR,
                graphHeight: graphHeight
            }));
            
            function drawFrame(progress) {
                // Clear
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(0, 0, width, height);
                
                // Draw zero line
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding.left, zeroY);
                ctx.lineTo(width - padding.right, zeroY);
                ctx.stroke();
                
                // Draw R labels
                ctx.fillStyle = '#555';
                ctx.font = '11px monospace';
                ctx.textAlign = 'right';
                ctx.fillText('+' + maxR + 'R', padding.left - 5, padding.top + 10);
                ctx.fillText('0', padding.left - 5, zeroY + 4);
                ctx.fillText('-' + maxR + 'R', padding.left - 5, padding.top + graphHeight - 2);
                
                if (slots.length === 0) {
                    ctx.fillStyle = '#555';
                    ctx.font = '12px system-ui';
                    ctx.textAlign = 'center';
                    ctx.fillText('No trades yet', width / 2, height / 2);
                    return;
                }
                
                // Draw bars with animation
                slots.forEach((slot, i) => {
                    const x = padding.left + gap + i * (barWidth + gap);
                    
                    // Green bar (positive) going UP
                    if (slot.positiveR > 0) {
                        const fullBarHeight = (slot.positiveR / maxR) * (graphHeight / 2);
                        const barHeight = fullBarHeight * progress;
                        const y = zeroY - barHeight;
                        
                        ctx.fillStyle = 'rgba(34,197,94,0.8)';
                        ctx.fillRect(x, y, barWidth, barHeight);
                        ctx.strokeStyle = '#22c55e';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, barWidth, barHeight);
                        
                        // Text when animation complete
                        if (progress > 0.7) {
                            const textAlpha = (progress - 0.7) / 0.3;
                            
                            // Count inside bar
                            if (barHeight > 16) {
                                ctx.fillStyle = `rgba(255,255,255,${textAlpha})`;
                                ctx.font = 'bold 12px system-ui';
                                ctx.textAlign = 'center';
                                ctx.fillText(slot.positiveCount, x + barWidth / 2, y + barHeight / 2 + 4);
                            }
                            
                            // R value above bar
                            ctx.fillStyle = `rgba(34,197,94,${textAlpha})`;
                            ctx.font = 'bold 10px monospace';
                            ctx.textAlign = 'center';
                            ctx.fillText('+' + slot.positiveR + 'R', x + barWidth / 2, y - 4);
                        }
                    }
                    
                    // Red bar (negative) going DOWN
                    if (slot.negativeR < 0) {
                        const fullBarHeight = (Math.abs(slot.negativeR) / maxR) * (graphHeight / 2);
                        const barHeight = fullBarHeight * progress;
                        const y = zeroY;
                        
                        ctx.fillStyle = 'rgba(239,68,68,0.8)';
                        ctx.fillRect(x, y, barWidth, barHeight);
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, barWidth, barHeight);
                        
                        // Text when animation complete
                        if (progress > 0.7) {
                            const textAlpha = (progress - 0.7) / 0.3;
                            
                            // Count inside bar
                            if (barHeight > 16) {
                                ctx.fillStyle = `rgba(255,255,255,${textAlpha})`;
                                ctx.font = 'bold 12px system-ui';
                                ctx.textAlign = 'center';
                                ctx.fillText(slot.negativeCount, x + barWidth / 2, y + barHeight / 2 + 4);
                            }
                            
                            // R value below bar
                            ctx.fillStyle = `rgba(239,68,68,${textAlpha})`;
                            ctx.font = 'bold 10px monospace';
                            ctx.textAlign = 'center';
                            ctx.fillText(slot.negativeR + 'R', x + barWidth / 2, y + barHeight + 12);
                        }
                    }
                    
                    // Time label (always visible)
                    ctx.fillStyle = '#666';
                    ctx.font = '10px system-ui';
                    ctx.textAlign = 'center';
                    const timeLabel = slot.time.replace(':00', '').replace(' ', '');
                    ctx.save();
                    ctx.translate(x + barWidth / 2, height - padding.bottom + 12);
                    ctx.rotate(-0.5);
                    ctx.fillText(timeLabel, 0, 0);
                    ctx.restore();
                });
            }
            
            if (animate && slots.length > 0) {
                let startTime = null;
                const duration = 500;
                
                function animateFrame(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = 1 - Math.pow(1 - progress, 3);
                    drawFrame(easedProgress);
                    if (progress < 1) {
                        requestAnimationFrame(animateFrame);
                    }
                }
                
                requestAnimationFrame(animateFrame);
            } else {
                drawFrame(1);
            }
        }
        
        function openGraphTradesModal(slot) {
            const list = document.getElementById('tradesList');
            list.innerHTML = '';
            document.getElementById('viewTitle').textContent = 'Trades at ' + slot.time;
            
            if (slot.trades.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div>No trades</div>';
            } else {
                slot.trades.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'trade-item' + (t.taken ? '' : ' setup');
                    div.innerHTML = '<div class="trade-info"><div class="trade-ticker">' + t.ticker + ' <span style="font-size:9px;color:#555">D' + (t.dayIndex + 1) + '</span>' + (t.taken ? '' : '<span style="font-size:9px;color:#555;margin-left:4px">(setup)</span>') + '</div><div class="trade-time">' + t.time + '</div></div><span class="trade-r ' + (t.r >= 0 ? 'green' : 'red') + '">' + (t.r > 0 ? '+' : '') + t.r + 'R</span>';
                    list.appendChild(div);
                });
            }
            
            // Hide back button and add trade button for graph view
            document.getElementById('viewBack').style.display = 'none';
            document.getElementById('viewAddBtn').style.display = 'none';
            hideAllModals();
            document.getElementById('viewModal').classList.remove('hidden');
        }
        
        // Update UI
        function updateStats() {
            const s = calcStats();
            
            // Show stats based on toggle
            const count = calendarShowAll ? s.allCount : s.myCount;
            const wins = calendarShowAll ? s.allWins : s.myWins;
            const losses = calendarShowAll ? s.allLosses : s.myLosses;
            const totalR = calendarShowAll ? s.allR : s.myR;
            
            document.getElementById('statTrades').textContent = count;
            document.getElementById('statWins').textContent = wins;
            document.getElementById('statLosses').textContent = losses;
            const rEl = document.getElementById('statR');
            rEl.textContent = (totalR > 0 ? '+' : '') + totalR.toFixed(1);
            rEl.className = 'stat-value ' + (totalR >= 0 ? 'green' : 'red');
            document.getElementById('statBalance').textContent = '$' + startingBalance.toLocaleString();
            
            // Calculate streak
            let streak = 0;
            let streakType = null;
            const allTrades = [];
            days.forEach(d => d.trades.forEach(t => {
                if (calendarShowAll || t.taken) allTrades.push(t);
            }));
            for (let i = allTrades.length - 1; i >= 0; i--) {
                const isWin = allTrades[i].r > 0;
                if (streakType === null) {
                    streakType = isWin;
                    streak = 1;
                } else if (isWin === streakType) {
                    streak++;
                } else {
                    break;
                }
            }
            const streakEl = document.getElementById('statStreak');
            if (streak === 0) {
                streakEl.textContent = '-';
                streakEl.className = 'stat-value';
            } else {
                streakEl.textContent = (streakType ? 'üî•' : 'üíÄ') + streak;
                streakEl.className = 'stat-value ' + (streakType ? 'green' : 'red');
            }
            
            const realBal = startingBalance * (1 + s.myR * 0.05);
            const setupsBal = startingBalance * (1 + s.allR * 0.05);
            const realEl = document.getElementById('realBalance');
            const setupsEl = document.getElementById('setupsBalance');
            realEl.textContent = '$' + Math.round(realBal).toLocaleString() + ' (' + (s.myR >= 0 ? '+' : '') + (s.myR * 5).toFixed(0) + '%)';
            setupsEl.textContent = '$' + Math.round(setupsBal).toLocaleString() + ' (' + (s.allR >= 0 ? '+' : '') + (s.allR * 5).toFixed(0) + '%)';
            realEl.className = 'balance-value ' + (realBal >= startingBalance ? 'green' : 'red');
            setupsEl.className = 'balance-value ' + (setupsBal >= startingBalance ? 'green' : 'red');
            
            // Progress bar - count days with trades based on toggle
            const daysWithTrades = days.filter(d => calendarShowAll ? d.trades.length > 0 : d.trades.some(t => t.taken)).length;
            document.getElementById('progressDays').textContent = daysWithTrades + '/50 days';
            document.getElementById('progressBar').style.width = (daysWithTrades / 50 * 100) + '%';
            
            // Daily goal - get current day (most recent day with trades based on toggle)
            let currentDayR = 0;
            for (let i = days.length - 1; i >= 0; i--) {
                const hasTrades = calendarShowAll ? days[i].trades.length > 0 : days[i].trades.some(t => t.taken);
                if (hasTrades) {
                    const trades = calendarShowAll ? days[i].trades : days[i].trades.filter(t => t.taken);
                    currentDayR = trades.reduce((sum, t) => sum + t.r, 0);
                    break;
                }
            }
            const dailyCurrent = document.getElementById('dailyGoalCurrent');
            dailyCurrent.textContent = (currentDayR >= 0 ? '+' : '') + currentDayR.toFixed(1);
            dailyCurrent.className = 'goal-current' + (currentDayR < dailyGoal ? ' behind' : '');
            document.getElementById('dailyGoalTarget').textContent = dailyGoal + 'R';
            document.getElementById('dailyGoalBtn').className = 'goal-box' + (currentDayR >= dailyGoal ? ' achieved' : '');
            
            // Weekly goal - get current week's R based on toggle
            const currentWeekIndex = Math.floor((daysWithTrades > 0 ? daysWithTrades - 1 : 0) / 5);
            const weekData = calcWeek(currentWeekIndex);
            const weeklyR = calendarShowAll ? weekData.allR : weekData.myR;
            const weeklyCurrent = document.getElementById('weeklyGoalCurrent');
            weeklyCurrent.textContent = (weeklyR >= 0 ? '+' : '') + weeklyR.toFixed(1);
            weeklyCurrent.className = 'goal-current' + (weeklyR < weeklyGoal ? ' behind' : '');
            document.getElementById('weeklyGoalTarget').textContent = weeklyGoal + 'R';
            document.getElementById('weeklyGoalBtn').className = 'goal-box' + (weeklyR >= weeklyGoal ? ' achieved' : '');
        }
        
        function renderCalendar() {
            [0, 1].forEach(pi => {
                const grid = document.getElementById('grid' + pi);
                grid.innerHTML = '';
                for (let r = 0; r < 5; r++) {
                    const row = document.createElement('div');
                    row.className = 'calendar-row';
                    for (let c = 0; c < 6; c++) {
                        const btn = document.createElement('button');
                        if (c === 5) {
                            // Week box
                            const wi = pi * 5 + r;
                            const w = calcWeek(wi);
                            const displayR = calendarShowAll ? w.allR : w.myR;
                            const displayLabel = calendarShowAll ? 'ALL' : 'WK' + (wi + 1);
                            const weekMoney = startingBalance * displayR * 0.05;
                            btn.className = 'day-box week' + (displayR < 0 ? ' negative' : '');
                            btn.innerHTML = `<span class="day-label week">${displayLabel}</span><span class="week-r ${displayR >= 0 ? 'green' : 'red'}">${displayR > 0 ? '+' : ''}${displayR.toFixed(1)}R</span><span class="week-money ${weekMoney >= 0 ? 'green' : 'red'}">${weekMoney >= 0 ? '+' : ''}$${Math.abs(Math.round(weekMoney))}</span>`;
                            btn.addEventListener('click', () => openWeekModal(wi));
                        } else {
                            // Day box
                            const dayIndex = pi * 25 + r * 5 + c;
                            const d = days[dayIndex];
                            const takenTrades = d.trades.filter(t => t.taken);
                            const allTrades = d.trades;
                            
                            // Show based on toggle
                            const showTrades = calendarShowAll ? allTrades : takenTrades;
                            const dr = showTrades.reduce((s, t) => s + t.r, 0);
                            const tc = showTrades.length;
                            const totalCount = allTrades.length;
                            
                            let cls = 'day-box';
                            if (dr < 0) cls += ' negative';
                            else if (tc > 0) cls += ' has-trades';
                            if (dayIndex === todayIndex) cls += ' today';
                            btn.className = cls;
                            
                            if (calendarShowAll) {
                                btn.innerHTML = `<span class="day-label">D${dayIndex + 1}</span><div class="day-count">${tc}</div>${tc > 0 ? `<span class="day-r ${dr >= 0 ? 'green' : 'red'}">${dr > 0 ? '+' : ''}${dr.toFixed(1)}R</span>` : ''}`;
                            } else {
                                btn.innerHTML = `<span class="day-label">D${dayIndex + 1}</span><div class="day-count">${tc}<span class="slash">/</span><span class="total">${totalCount}</span></div>${tc > 0 ? `<span class="day-r ${dr >= 0 ? 'green' : 'red'}">${dr > 0 ? '+' : ''}${dr.toFixed(1)}R</span>` : ''}`;
                            }
                            btn.addEventListener('click', () => openMenuModal(dayIndex));
                        }
                        row.appendChild(btn);
                    }
                    grid.appendChild(row);
                }
                
                // Update toggle button states
                document.getElementById('calMyTrades' + pi).className = 'calendar-toggle' + (calendarShowAll ? '' : ' active');
                document.getElementById('calAllTrades' + pi).className = 'calendar-toggle' + (calendarShowAll ? ' active' : '');
            });
        }
        
        function setPage(p) {
            currentPage = p;
            document.getElementById('calendarSlider').style.transform = `translateX(-${p * 33.333}%)`;
            document.getElementById('dot0').className = 'dot' + (p === 0 ? ' active' : '');
            document.getElementById('dot1').className = 'dot' + (p === 1 ? ' active' : '');
            document.getElementById('dot2').className = 'dot' + (p === 2 ? ' active' : '');
            if (p === 2) renderGraph();
        }
        
        // Swipe
        let touchStartX = 0;
        document.getElementById('calendarWrap').addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
        document.getElementById('calendarWrap').addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - touchStartX;
            if (Math.abs(dx) > 50) {
                if (dx < 0 && currentPage < 2) setPage(currentPage + 1);
                else if (dx > 0 && currentPage > 0) setPage(currentPage - 1);
            }
        });
        
        document.getElementById('dot0').addEventListener('click', () => setPage(0));
        document.getElementById('dot1').addEventListener('click', () => setPage(1));
        document.getElementById('dot2').addEventListener('click', () => setPage(2));
        
        // Calendar toggles
        ['0', '1'].forEach(pi => {
            document.getElementById('calMyTrades' + pi).addEventListener('click', () => {
                calendarShowAll = false;
                renderCalendar();
                updateStats();
            });
            document.getElementById('calAllTrades' + pi).addEventListener('click', () => {
                calendarShowAll = true;
                renderCalendar();
                updateStats();
            });
        });
        
        // Graph toggles
        document.getElementById('graphMyTrades').addEventListener('click', () => {
            graphShowAll = false;
            document.getElementById('graphMyTrades').classList.add('active');
            document.getElementById('graphAllTrades').classList.remove('active');
            renderGraph(true);
        });
        document.getElementById('graphAllTrades').addEventListener('click', () => {
            graphShowAll = true;
            document.getElementById('graphAllTrades').classList.add('active');
            document.getElementById('graphMyTrades').classList.remove('active');
            renderGraph(true);
        });
        
        // Graph bar click detection
        document.getElementById('graphCanvas').addEventListener('click', (e) => {
            const canvas = document.getElementById('graphCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Find which bar was clicked
            for (const slot of graphSlots) {
                if (x >= slot.x && x <= slot.x + slot.barWidth) {
                    openGraphTradesModal(slot);
                    return;
                }
            }
        });
        
        // Modals
        function hideAllModals() {
            ['menuModal', 'viewModal', 'addModal', 'editModal', 'weekModal', 'clearModal', 'balanceModal', 'reviewModal', 'goalModal'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }
        
        function openMenuModal(dayIndex) {
            selectedDay = dayIndex;
            document.getElementById('menuTitle').textContent = 'Day ' + (dayIndex + 1);
            hideAllModals();
            document.getElementById('menuModal').classList.remove('hidden');
        }
        
        function openViewModal() {
            document.getElementById('viewTitle').textContent = 'Day ' + (selectedDay + 1) + ' Trades';
            document.getElementById('viewBack').style.display = 'block';
            document.getElementById('viewAddBtn').style.display = 'block';
            const list = document.getElementById('tradesList');
            list.innerHTML = '';
            const trades = days[selectedDay].trades;
            if (trades.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div>No trades yet</div>';
            } else {
                trades.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'trade-item' + (t.taken ? '' : ' setup');
                    const indicators = [];
                    if (t.notes) indicators.push('üìù');
                    if (t.photo) indicators.push('üì∑');
                    div.innerHTML = '<div class="trade-info"><div class="trade-ticker">' + t.ticker + (t.taken ? '' : '<span style="font-size:9px;color:#555;margin-left:4px">(setup)</span>') + (indicators.length ? '<span style="font-size:10px;margin-left:6px">' + indicators.join(' ') + '</span>' : '') + '</div><div class="trade-time">' + t.time + '</div></div><span class="trade-r ' + (t.r >= 0 ? 'green' : 'red') + '">' + (t.r > 0 ? '+' : '') + t.r + 'R</span><button class="trade-btn edit-btn" data-id="' + t.id + '">‚úé</button><button class="trade-btn delete-btn" data-id="' + t.id + '">üóë</button>';
                    list.appendChild(div);
                });
                list.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(parseInt(btn.dataset.id))));
                list.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => deleteTrade(parseInt(btn.dataset.id))));
            }
            hideAllModals();
            document.getElementById('viewModal').classList.remove('hidden');
        }
        
        function openAddModal() {
            document.getElementById('tickerInput').value = '';
            document.getElementById('timeSelect').value = '9:30 AM';
            document.getElementById('rSelect').value = '2';
            document.querySelectorAll('#rBtns .r-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.r === '2');
            });
            document.getElementById('notesInput').value = '';
            newTradeTaken = true;
            newTradePhoto = null;
            newTradeTags = [];
            document.getElementById('typeTaken').className = 'type-btn active';
            document.getElementById('typeSetup').className = 'type-btn';
            document.querySelectorAll('#tagsWrap .tag-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoPreview').className = 'photo-preview';
            hideAllModals();
            document.getElementById('addModal').classList.remove('hidden');
        }
        
        function openEditModal(tradeId) {
            const trade = days[selectedDay].trades.find(t => t.id === tradeId);
            if (!trade) return;
            editingTrade = trade;
            document.getElementById('editTickerInput').value = trade.ticker;
            document.getElementById('editTimeSelect').value = trade.time;
            document.getElementById('editRSelect').value = trade.r.toString();
            document.getElementById('editNotesInput').value = trade.notes || '';
            editTradeTaken = trade.taken;
            editTradePhoto = trade.photo || null;
            editTradeTags = trade.tags ? [...trade.tags] : [];
            document.getElementById('editTypeTaken').className = 'type-btn' + (trade.taken ? ' active' : '');
            document.getElementById('editTypeSetup').className = 'type-btn' + (trade.taken ? '' : ' active');
            // Set R buttons
            document.getElementById('editRSelect').value = trade.r.toString();
            document.querySelectorAll('#editRBtns .r-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.r === trade.r.toString());
            });
            // Set tag buttons
            document.querySelectorAll('#editTagsWrap .tag-btn').forEach(btn => {
                btn.classList.toggle('active', editTradeTags.includes(btn.dataset.tag));
            });
            const preview = document.getElementById('editPhotoPreview');
            if (editTradePhoto) {
                preview.innerHTML = '<img src="' + editTradePhoto + '"><button class="photo-remove" id="editRemovePhoto">√ó</button>';
                preview.className = 'photo-preview has-photo';
            } else {
                preview.innerHTML = '';
                preview.className = 'photo-preview';
            }
            hideAllModals();
            document.getElementById('editModal').classList.remove('hidden');
            if (editTradePhoto) {
                document.getElementById('editRemovePhoto').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editTradePhoto = null;
                    preview.innerHTML = '';
                    preview.className = 'photo-preview';
                });
            }
        }
        
        function openWeekModal(wi) {
            selectedWeek = wi;
            const w = calcWeek(wi);
            document.getElementById('weekTitle').textContent = 'Week ' + (wi + 1);
            const myREl = document.getElementById('weekMyR');
            myREl.className = 'week-stat full ' + (w.myR >= 0 ? 'positive' : 'negative');
            myREl.innerHTML = `<div class="week-stat-value big ${w.myR >= 0 ? 'green' : 'red'}">${w.myR > 0 ? '+' : ''}${w.myR.toFixed(1)}R</div>`;
            document.getElementById('weekMyTrades').textContent = w.my;
            document.getElementById('weekMyWinRate').textContent = w.my ? Math.round(w.myW / w.my * 100) + '%' : '0%';
            document.getElementById('weekMyWins').textContent = w.myW;
            document.getElementById('weekMyLosses').textContent = w.myL;
            const allREl = document.getElementById('weekAllR');
            allREl.className = 'week-stat full ' + (w.allR >= 0 ? 'positive' : 'negative');
            allREl.innerHTML = `<div class="week-stat-value big ${w.allR >= 0 ? 'green' : 'red'}">${w.allR > 0 ? '+' : ''}${w.allR.toFixed(1)}R</div>`;
            document.getElementById('weekAllTrades').textContent = w.all;
            document.getElementById('weekAllWinRate').textContent = w.all ? Math.round(w.allW / w.all * 100) + '%' : '0%';
            document.getElementById('weekAllWins').textContent = w.allW;
            document.getElementById('weekAllLosses').textContent = w.allL;
            hideAllModals();
            document.getElementById('weekModal').classList.remove('hidden');
        }
        
        // Actions
        function addTrade() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) return;
            days[selectedDay].trades.push({
                id: Date.now(),
                ticker,
                time: document.getElementById('timeSelect').value,
                r: parseFloat(document.getElementById('rSelect').value),
                taken: newTradeTaken,
                notes: document.getElementById('notesInput').value.trim(),
                photo: newTradePhoto,
                tags: [...newTradeTags]
            });
            saveData();
            updateStats();
            renderCalendar();
            newTradePhoto = null;
            newTradeTags = [];
            document.querySelectorAll('#tagsWrap .tag-btn').forEach(btn => btn.classList.remove('active'));
            openViewModal();
        }
        
        function saveEditTrade() {
            if (!editingTrade) return;
            const trade = days[selectedDay].trades.find(t => t.id === editingTrade.id);
            if (trade) {
                trade.ticker = document.getElementById('editTickerInput').value.trim().toUpperCase();
                trade.time = document.getElementById('editTimeSelect').value;
                trade.r = parseFloat(document.getElementById('editRSelect').value);
                trade.taken = editTradeTaken;
                trade.notes = document.getElementById('editNotesInput').value.trim();
                trade.photo = editTradePhoto;
                trade.tags = [...editTradeTags];
            }
            saveData();
            updateStats();
            renderCalendar();
            editTradePhoto = null;
            openViewModal();
        }
        
        function deleteTrade(tradeId) {
            days[selectedDay].trades = days[selectedDay].trades.filter(t => t.id !== tradeId);
            saveData();
            updateStats();
            renderCalendar();
            openViewModal();
        }
        
        function clearPageData(pageNum) {
            for (let i = pageNum * 25; i < pageNum * 25 + 25; i++) days[i] = { id: i, trades: [] };
            saveData();
            updateStats();
            renderCalendar();
            hideAllModals();
        }
        
        // Event listeners
        document.getElementById('menuClose').addEventListener('click', hideAllModals);
        document.getElementById('viewClose').addEventListener('click', hideAllModals);
        document.getElementById('addClose').addEventListener('click', hideAllModals);
        document.getElementById('editClose').addEventListener('click', hideAllModals);
        document.getElementById('weekClose').addEventListener('click', hideAllModals);
        document.getElementById('clearClose').addEventListener('click', hideAllModals);
        document.getElementById('balanceClose').addEventListener('click', hideAllModals);
        
        document.getElementById('addTradeBtn').addEventListener('click', openAddModal);
        document.getElementById('viewTradesBtn').addEventListener('click', openViewModal);
        document.getElementById('viewAddBtn').addEventListener('click', openAddModal);
        document.getElementById('duplicateBtn').addEventListener('click', () => {
            // Find last trade across all days
            let lastTrade = null;
            for (let i = days.length - 1; i >= 0; i--) {
                if (days[i].trades.length > 0) {
                    lastTrade = days[i].trades[days[i].trades.length - 1];
                    break;
                }
            }
            if (lastTrade) {
                // Open add modal with prefilled data
                document.getElementById('tickerInput').value = lastTrade.ticker;
                document.getElementById('timeSelect').value = lastTrade.time;
                document.getElementById('rSelect').value = '2';
                document.querySelectorAll('#rBtns .r-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.r === '2');
                });
                newTradeTaken = lastTrade.taken;
                document.getElementById('typeTaken').className = 'type-btn' + (lastTrade.taken ? ' active' : '');
                document.getElementById('typeSetup').className = 'type-btn' + (lastTrade.taken ? '' : ' active');
                newTradeTags = [];
                document.querySelectorAll('#tagsWrap .tag-btn').forEach(btn => btn.classList.remove('active'));
                newTradePhoto = null;
                document.getElementById('photoPreview').innerHTML = '';
                document.getElementById('photoPreview').className = 'photo-preview';
                document.getElementById('notesInput').value = '';
                hideAllModals();
                document.getElementById('addModal').classList.remove('hidden');
            } else {
                openAddModal();
            }
        });
        document.getElementById('viewBack').addEventListener('click', () => openMenuModal(selectedDay));
        document.getElementById('addBack').addEventListener('click', openViewModal);
        document.getElementById('editBack').addEventListener('click', openViewModal);
        
        document.getElementById('typeTaken').addEventListener('click', () => { newTradeTaken = true; document.getElementById('typeTaken').className = 'type-btn active'; document.getElementById('typeSetup').className = 'type-btn'; });
        document.getElementById('typeSetup').addEventListener('click', () => { newTradeTaken = false; document.getElementById('typeTaken').className = 'type-btn'; document.getElementById('typeSetup').className = 'type-btn active'; });
        document.getElementById('editTypeTaken').addEventListener('click', () => { editTradeTaken = true; document.getElementById('editTypeTaken').className = 'type-btn active'; document.getElementById('editTypeSetup').className = 'type-btn'; });
        document.getElementById('editTypeSetup').addEventListener('click', () => { editTradeTaken = false; document.getElementById('editTypeTaken').className = 'type-btn'; document.getElementById('editTypeSetup').className = 'type-btn active'; });
        
        // R button handling for Add Trade
        document.querySelectorAll('#rBtns .r-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('#rBtns .r-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('rSelect').value = btn.dataset.r;
            });
        });
        
        // R button handling for Edit Trade
        document.querySelectorAll('#editRBtns .r-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('#editRBtns .r-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('editRSelect').value = btn.dataset.r;
            });
        });
        
        // Tag handling for Add Trade
        document.querySelectorAll('#tagsWrap .tag-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const tag = btn.dataset.tag;
                if (newTradeTags.includes(tag)) {
                    newTradeTags = newTradeTags.filter(t => t !== tag);
                    btn.classList.remove('active');
                } else {
                    newTradeTags.push(tag);
                    btn.classList.add('active');
                }
            });
        });
        
        // Tag handling for Edit Trade
        document.querySelectorAll('#editTagsWrap .tag-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const tag = btn.dataset.tag;
                if (editTradeTags.includes(tag)) {
                    editTradeTags = editTradeTags.filter(t => t !== tag);
                    btn.classList.remove('active');
                } else {
                    editTradeTags.push(tag);
                    btn.classList.add('active');
                }
            });
        });
        
        // Goal handlers
        document.getElementById('dailyGoalBtn').addEventListener('click', () => {
            currentGoalType = 'daily';
            document.getElementById('goalModalTitle').textContent = 'Set Daily Goal';
            document.getElementById('goalInput').value = dailyGoal;
            hideAllModals();
            document.getElementById('goalModal').classList.remove('hidden');
        });
        document.getElementById('weeklyGoalBtn').addEventListener('click', () => {
            currentGoalType = 'weekly';
            document.getElementById('goalModalTitle').textContent = 'Set Weekly Goal';
            document.getElementById('goalInput').value = weeklyGoal;
            hideAllModals();
            document.getElementById('goalModal').classList.remove('hidden');
        });
        document.getElementById('goalClose').addEventListener('click', hideAllModals);
        document.querySelectorAll('.goal-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('goalInput').value = btn.dataset.amount;
            });
        });
        document.getElementById('saveGoal').addEventListener('click', () => {
            const val = parseFloat(document.getElementById('goalInput').value);
            if (!isNaN(val) && val > 0) {
                if (currentGoalType === 'daily') {
                    dailyGoal = val;
                    saveToDB('dailyGoal', dailyGoal);
                } else {
                    weeklyGoal = val;
                    saveToDB('weeklyGoal', weeklyGoal);
                }
                updateStats();
                hideAllModals();
            }
        });
        
        // Weekly review
        document.getElementById('weeklyReviewBtn').addEventListener('click', () => {
            generateWeeklyReview();
            hideAllModals();
            document.getElementById('reviewModal').classList.remove('hidden');
        });
        document.getElementById('reviewClose').addEventListener('click', hideAllModals);
        
        function generateWeeklyReview() {
            const s = calcStats();
            const daysWithTrades = days.filter(d => d.trades.some(t => t.taken)).length;
            const currentWeekIndex = Math.floor((daysWithTrades > 0 ? daysWithTrades - 1 : 0) / 5);
            const weekData = calcWeek(currentWeekIndex);
            
            // Count tags across all trades
            const tagCounts = {};
            days.forEach(d => d.trades.forEach(t => {
                if (t.tags) t.tags.forEach(tag => { tagCounts[tag] = (tagCounts[tag] || 0) + 1; });
            }));
            
            // Best and worst days
            let bestDay = { index: -1, r: -Infinity };
            let worstDay = { index: -1, r: Infinity };
            days.forEach((d, i) => {
                const dr = d.trades.filter(t => t.taken).reduce((sum, t) => sum + t.r, 0);
                if (d.trades.some(t => t.taken)) {
                    if (dr > bestDay.r) bestDay = { index: i, r: dr };
                    if (dr < worstDay.r) worstDay = { index: i, r: dr };
                }
            });
            
            const winRate = s.myCount > 0 ? ((s.myWins / s.myCount) * 100).toFixed(0) : 0;
            
            let html = '<div class="review-section"><div class="review-title">üìà Week ' + (currentWeekIndex + 1) + ' Summary</div>';
            html += '<div class="review-stat"><span class="review-stat-label">Trades Taken</span><span class="review-stat-value">' + weekData.my + '</span></div>';
            html += '<div class="review-stat"><span class="review-stat-label">Win Rate</span><span class="review-stat-value">' + winRate + '%</span></div>';
            html += '<div class="review-stat"><span class="review-stat-label">Total R</span><span class="review-stat-value ' + (weekData.myR >= 0 ? 'green' : 'red') + '">' + (weekData.myR >= 0 ? '+' : '') + weekData.myR.toFixed(1) + 'R</span></div>';
            html += '<div class="review-stat"><span class="review-stat-label">Weekly Goal</span><span class="review-stat-value">' + (weekData.myR >= weeklyGoal ? '‚úÖ Achieved!' : '‚ùå ' + (weeklyGoal - weekData.myR).toFixed(1) + 'R to go') + '</span></div>';
            html += '</div>';
            
            html += '<div class="review-section"><div class="review-title">üèÜ Challenge Progress</div>';
            html += '<div class="review-stat"><span class="review-stat-label">Days Completed</span><span class="review-stat-value">' + daysWithTrades + '/50</span></div>';
            html += '<div class="review-stat"><span class="review-stat-label">Overall R</span><span class="review-stat-value ' + (s.myR >= 0 ? 'green' : 'red') + '">' + (s.myR >= 0 ? '+' : '') + s.myR.toFixed(1) + 'R</span></div>';
            if (bestDay.index >= 0) html += '<div class="review-stat"><span class="review-stat-label">Best Day</span><span class="review-stat-value green">D' + (bestDay.index + 1) + ' (+' + bestDay.r.toFixed(1) + 'R)</span></div>';
            if (worstDay.index >= 0 && worstDay.r < 0) html += '<div class="review-stat"><span class="review-stat-label">Worst Day</span><span class="review-stat-value red">D' + (worstDay.index + 1) + ' (' + worstDay.r.toFixed(1) + 'R)</span></div>';
            html += '</div>';
            
            if (Object.keys(tagCounts).length > 0) {
                html += '<div class="review-section"><div class="review-title">üè∑Ô∏è Trade Tags</div><div class="review-tags">';
                Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).forEach(([tag, count]) => {
                    html += '<span class="review-tag">' + tag + '<span class="count">√ó' + count + '</span></span>';
                });
                html += '</div></div>';
            }
            
            document.getElementById('reviewContent').innerHTML = html;
        }
        
        document.getElementById('submitTrade').addEventListener('click', (e) => { e.stopPropagation(); addTrade(); });
        document.getElementById('saveEdit').addEventListener('click', (e) => { e.stopPropagation(); saveEditTrade(); });
        
        // Photo handling for Add Trade
        document.getElementById('takePhotoBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const input = document.getElementById('photoInput');
            input.setAttribute('capture', 'environment');
            input.click();
        });
        document.getElementById('choosePhotoBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const input = document.getElementById('photoInput');
            input.removeAttribute('capture');
            input.click();
        });
        document.getElementById('photoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    newTradePhoto = ev.target.result;
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = '<img src="' + newTradePhoto + '"><button class="photo-remove" id="removePhoto">√ó</button>';
                    preview.className = 'photo-preview has-photo';
                    document.getElementById('removePhoto').addEventListener('click', (e) => {
                        e.stopPropagation();
                        newTradePhoto = null;
                        preview.innerHTML = '';
                        preview.className = 'photo-preview';
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Photo handling for Edit Trade
        document.getElementById('editTakePhotoBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const input = document.getElementById('editPhotoInput');
            input.setAttribute('capture', 'environment');
            input.click();
        });
        document.getElementById('editChoosePhotoBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const input = document.getElementById('editPhotoInput');
            input.removeAttribute('capture');
            input.click();
        });
        document.getElementById('editPhotoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    editTradePhoto = ev.target.result;
                    const preview = document.getElementById('editPhotoPreview');
                    preview.innerHTML = '<img src="' + editTradePhoto + '"><button class="photo-remove" id="editRemovePhoto">√ó</button>';
                    preview.className = 'photo-preview has-photo';
                    document.getElementById('editRemovePhoto').addEventListener('click', (e) => {
                        e.stopPropagation();
                        editTradePhoto = null;
                        preview.innerHTML = '';
                        preview.className = 'photo-preview';
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('refreshBtn').addEventListener('click', () => { hideAllModals(); document.getElementById('clearModal').classList.remove('hidden'); });
        document.getElementById('clearPage1').addEventListener('click', () => clearPageData(0));
        document.getElementById('clearPage2').addEventListener('click', () => clearPageData(1));
        document.getElementById('clearCancel').addEventListener('click', hideAllModals);
        
        document.getElementById('balanceBtn').addEventListener('click', () => {
            document.getElementById('currentBalance').textContent = '$' + startingBalance.toLocaleString();
            document.getElementById('balanceInput').value = '';
            hideAllModals();
            document.getElementById('balanceModal').classList.remove('hidden');
        });
        document.querySelectorAll('.balance-preset').forEach(btn => btn.addEventListener('click', () => { document.getElementById('balanceInput').value = btn.dataset.amount; }));
        document.getElementById('saveBalance').addEventListener('click', () => {
            const val = parseFloat(document.getElementById('balanceInput').value);
            if (!isNaN(val) && val > 0) { startingBalance = val; saveData(); updateStats(); hideAllModals(); }
        });
        
        // Click outside modal to close
        ['menuModal', 'viewModal', 'addModal', 'editModal', 'weekModal', 'clearModal', 'balanceModal'].forEach(id => {
            document.getElementById(id).addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) hideAllModals(); });
        });
        
        // Init - load from IndexedDB
        openDB().then(async () => {
            const savedDays = await loadFromDB('days');
            const savedBalance = await loadFromDB('balance');
            const savedDailyGoal = await loadFromDB('dailyGoal');
            const savedWeeklyGoal = await loadFromDB('weeklyGoal');
            if (savedDays && Array.isArray(savedDays)) {
                // Merge saved days with default array (handles old data with fewer days)
                for (let i = 0; i < savedDays.length && i < 50; i++) {
                    if (savedDays[i] && savedDays[i].trades) {
                        days[i] = savedDays[i];
                    }
                }
            }
            if (savedBalance) startingBalance = savedBalance;
            if (savedDailyGoal) dailyGoal = savedDailyGoal;
            if (savedWeeklyGoal) weeklyGoal = savedWeeklyGoal;
            // Calculate todayIndex - first day without taken trades, or last day with trades
            todayIndex = 0;
            for (let i = 0; i < days.length; i++) {
                if (days[i].trades.some(t => t.taken)) {
                    todayIndex = i;
                }
            }
            // If last day has trades, move to next day (unless at end)
            if (todayIndex < 49 && days[todayIndex].trades.some(t => t.taken)) {
                todayIndex++;
            }
            updateStats();
            renderCalendar();
        }).catch(err => {
            console.error('DB Error:', err);
            updateStats();
            renderCalendar();
        });
        
        // Hamburger menu
        document.getElementById('hamburgerBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('hamburgerMenu');
            const btn = document.getElementById('hamburgerBtn');
            menu.classList.toggle('open');
            btn.classList.toggle('active');
        });
        
        // Close hamburger menu when clicking outside
        document.addEventListener('click', () => {
            document.getElementById('hamburgerMenu').classList.remove('open');
            document.getElementById('hamburgerBtn').classList.remove('active');
        });
        
        document.getElementById('hamburgerMenu').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Export data
        document.getElementById('exportBtn').addEventListener('click', () => {
            const data = {
                days: days,
                startingBalance: startingBalance,
                exportDate: new Date().toISOString()
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trading-journal-backup-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            document.getElementById('hamburgerMenu').classList.remove('open');
            document.getElementById('hamburgerBtn').classList.remove('active');
        });
        
        // Import data
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });
        
        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.days && Array.isArray(data.days)) {
                            // Reset days array
                            days = Array.from({length: 50}, (_, i) => ({ id: i, trades: [] }));
                            // Merge imported days
                            for (let i = 0; i < data.days.length && i < 50; i++) {
                                if (data.days[i] && data.days[i].trades) {
                                    days[i] = data.days[i];
                                }
                            }
                            if (data.startingBalance) startingBalance = data.startingBalance;
                            saveData();
                            updateStats();
                            renderCalendar();
                            alert('Data imported successfully!');
                        } else {
                            alert('Invalid backup file format.');
                        }
                    } catch (err) {
                        alert('Error reading file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            }
            e.target.value = '';
            document.getElementById('hamburgerMenu').classList.remove('open');
            document.getElementById('hamburgerBtn').classList.remove('active');
        });
    </script>
</body>
</html>
